function Whitewater(t,e,n){"use strict";function i(){this.canvas.play=this.play,this.canvas.pause=this.pause,this.canvas.playpause=this.playpause,this.canvas.stop=this.stop}function a(){"hidden"in document?(P="hidden",document.addEventListener("visibilitychange",E.bind(this),!1)):"mozHidden"in document?(P="mozHidden",document.addEventListener("mozvisibilitychange",E.bind(this),!1)):"msHidden"in document?(P="msHidden",document.addEventListener("msvisibilitychange",E.bind(this),!1)):"webkitHidden"in document?(P="webkitHidden",document.addEventListener("webkitvisibilitychange",E.bind(this),!1)):"onfocusin"in document?(document.addEventListener("focusin",E.bind(this,!1),!1),document.addEventListener("focusout",E.bind(this,!0),!1)):"onpageshow"in window?(window.addEventListener("pageshow",E.bind(this,!1),!1),window.addEventListener("pagehide",E.bind(this,!0),!1)):(window.addEventListener("focus",E.bind(this,!1),!1),window.addEventListener("blur",E.bind(this,!0),!1))}function s(){if(++T>z.imagesRequired){this.canvas.setAttribute("data-state","ready"),this.state="ready";var t=new CustomEvent("whitewaterload",o.call(this));this.canvas.dispatchEvent(t),n.autoplay&&this.play()}}function r(){var t=null;t=0===this.currentFrame?I:d(R[this.currentFrame-1]),W.drawImage(t,0,0),this.currentFrame++,w.call(this)}function o(){return{detail:{video:this,currentFrame:this.currentFrame,progress:this.progress,timestamp:this.timestamp,maxTime:this.maxTime,state:this.state,secondsElapsed:this.secondsElapsed},bubbles:!0,cancelable:!1}}function d(t){var e=document.createElement("canvas");e.width=z.videoWidth,e.height=z.videoHeight;for(var n=0;n<t.length;n++){var i=t[n][0],a=t[n][1],s=S(i),r=a*z.blockSize;if(e.getContext("2d").drawImage(x[A],C.x*z.blockSize,C.y*z.blockSize,r,z.blockSize,s[0]*z.blockSize,s[1]*z.blockSize,r,z.blockSize),C.x+=a,C.x>=z.sourceGrid&&(C.x=0,++C.y>=z.sourceGrid&&(C.y=0,++A>=x.length)))throw"imageIndex exceeded diffImages.length\n\nmapLength = "+t.length+"\nj = "+n}return e}function c(){var t=this;I.addEventListener("load",function(){s.call(t),f.call(t)},!1),I.src=M+"first."+z.format;for(var e=1;e<=z.imagesRequired;e++){var n=new Image;n.addEventListener("load",s.bind(this),!1),n.src=e>99?M+"diff_"+e+"."+z.format:e>9?M+"diff_0"+e+"."+z.format:M+"diff_00"+e+"."+z.format,x.push(n)}}function h(t){var e=this,i=new XMLHttpRequest;i.open("GET",M+"manifest.json",!1),i.addEventListener("load",function(){try{F=JSON.parse(i.responseText)}catch(t){return void this.constructor._throwError(t)}g.call(this),b.call(this);var a=null,s=function(){function t(t){for(var e,n=0;t.length;)e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(t.charAt(0)),t=t.substr(1),n*=64,n+=e;return n}return onmessage=function(e){for(var n=e.data,i=[],a=0;a<n.length;a++){var s=n[a],r=[];if(""!==s)for(var o=s.match(/.{1,5}/g),d=o.length,c=0;c<d;c++){var h=t(o[c].substr(0,3)),u=t(o[c].substr(3,2));r.push([h,u])}i.push(r)}try{postMessage(i)}catch(t){}},!0};if(s()){var r=window.URL||window.webkitURL,o=new Blob(["("+s.toString()+")()"],{type:"text/javascript"});a=new Worker(r.createObjectURL(o))}else a=new Worker("whitewater.worker.js");try{a.postMessage(F.frames)}catch(t){}a.onmessage=function(i){R=i.data,a.terminate();for(var s=0;s<t.length;s++)t[s]();n.controls&&m.call(e)}}.bind(this),!1),i.addEventListener("error",function(){try{throw this.constructor.errors.MANIFEST}catch(t){return void this.constructor._throwError(t)}}.bind(this),!1),i.send()}function u(){A=0,C.x=0,C.y=0,this.currentFrame=0,W.clearRect(0,0,z.videoWidth,z.videoHeight)}function l(){if(!(t instanceof HTMLCanvasElement))throw this.constructor.errors.CANVAS;this.canvas=t,W=this.canvas.getContext("2d")}function v(){if("string"!=typeof e)throw this.constructor.errors.PATH;M=e,"/"!==e.substr(-1)&&(M+="/")}function p(){if(n){var t=1;n.speed&&n.speed<1&&(t=n.speed),n={loop:n.loop||!1,autoplay:n.autoplay||!1,controls:n.controls||!1,speed:t}}}function m(){var t=this.canvas;"boolean"!=typeof n.controls&&(t=n.controls);var e=y();t.addEventListener(e,this.playpause)}function f(){var t=I.src,e=this.canvas.style.paddingTop;this.canvas.style.background="transparent url("+t+") no-repeat center "+e,this.canvas.style.backgroundSize="contain"}function w(){this.progress=L(this.currentFrame/z.frameCount*100,3);var t=this.currentFrame/z.framesPerSecond;this.timestamp=k(t),this.secondsElapsed=L(t,3);var e=new CustomEvent("whitewaterprogressupdate",o.call(this));this.canvas.dispatchEvent(e)}function b(){this.canvas.setAttribute("width",z.videoWidth+"px"),this.canvas.setAttribute("height",z.videoHeight+"px")}function g(){var t="";switch(F.format){case"JPEG":t="jpg";break;case"PNG":t="png";break;case"GIF":t="gif";break;default:t="jpg"}var e=(z={videoWidth:F.videoWidth,videoHeight:F.videoHeight,imagesRequired:F.imagesRequired,frameCount:F.frameCount-1,blockSize:F.blockSize,sourceGrid:F.sourceGrid,framesPerSecond:Math.round(F.framesPerSecond),format:t}).frameCount/z.framesPerSecond;this.maxTime=k(e)}function E(t){void 0!==t&&(B=t),!document[P]&&!0!==B||"playing"!==O.state?"suspended"===O.state&&this.play():(this.state="suspended",this.pause())}function y(){return"ontouchstart"in document.documentElement?"touchend":"mouseup"}function S(t){var e=Math.ceil(z.videoWidth/z.blockSize);return t<e?[t,0]:[t%e,Math.floor(t/e)]}function k(t){var e=Math.floor(t/60),n=Math.floor(t%60),i=Math.floor(t%60%1*1e3);return e<10&&(e="0"+e),n<10&&(n="0"+n),i<10?i="00"+i:i<100&&(i="0"+i),e+":"+n+"."+i}function L(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var W=null,A=0,C={x:0,y:0},T=0,I=new Image,x=[],H=null,R=null,F=null,M="",z={},P=null,B=!1;this.state="loading",this.currentFrame=0,this.progress=0,this.timestamp="00:00.000",this.maxTime="00:00.000",this.secondsElapsed=0,Whitewater.supported&&function(){try{l.call(this),v(),p();var t=[c.bind(this),i.bind(this),a.bind(this)];h.call(this,t)}catch(t){return void this.constructor._throwError(t)}}.call(this);var O=this;this.pause=function(){if("paused"!==O.state){if("suspended"!==O.state){O.canvas.setAttribute("data-state","paused"),O.state="paused";var t=new CustomEvent("whitewaterpause",o.call(O));O.canvas.dispatchEvent(t)}cancelAnimationFrame(H)}},this.play=function(){function t(e){var i=e-s;if(i>=a){if(O.currentFrame<z.frameCount+1)r.call(O);else if(n.loop){u.call(O),r.call(O);var d=new CustomEvent("whitewaterloop",o.call(O));O.canvas.dispatchEvent(d)}else{O.stop(),O.canvas.setAttribute("data-state","ended"),O.state="ended";var c=new CustomEvent("whitewaterend",o.call(O));O.canvas.dispatchEvent(c)}s=e-(i-a)}document[P]||!0===B||"playing"!==O.state||(H=requestAnimationFrame(t))}if("playing"!==O.state){"ended"===O.state&&u.call(O);var e="suspended"===O.state;if(O.canvas.setAttribute("data-state","playing"),O.state="playing",!e){var i=new CustomEvent("whitewaterplay",o.call(O));O.canvas.dispatchEvent(i)}var a=L(1/z.framesPerSecond*1e3/n.speed,2),s=window.performance.now();t(s)}},this.playpause=function(){"playing"===O.state?O.pause():"loading"!==O.state&&O.play()},this.stop=function(){if("ready"!==O.state){O.canvas.setAttribute("data-state","ready"),O.state="ready";var t=new CustomEvent("whitewaterend",o.call(O));O.canvas.dispatchEvent(t),cancelAnimationFrame(H),u.call(O),w.call(O)}}}Whitewater.errors={pre:"Whitewater: ",MISC:"Whatever.",WEBWORKERS:"This browser does not support Web Workers.",BLOBCONSTRUCTOR:"This browser does not support the Blob() constructor.",VISIBILITYAPI:"This browser does not support the Visiblity API",CANVAS:'"canvas" must be a valid HTML canvas element.',PATH:'"path" must be a path to a directory containing a manifest.json file',MANIFEST:"A manifest.json file could not be found."},Whitewater._checkSupport=function(){try{if(window.Blob){if(window.Worker){if("hidden"in document||"mozHidden"in document||"msHidden"in document||"webkitHidden"in document)return!0;throw this.errors.VISIBILITYAPI}throw this.errors.BLOBCONSTRUCTOR}throw this.errors.WEBWORKERS}catch(t){return this._throwError(t),!1}},Whitewater._throwError=function(t){console.warn(this.errors.pre+t)},Whitewater.supported=Whitewater._checkSupport();
